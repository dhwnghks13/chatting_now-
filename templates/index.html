<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’¬ ì±„íŒ…ë°©</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='icon.png') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { padding: 20px; font-family: 'Apple SD Gothic Neo', sans-serif; background-color: #f0f2f5; }
        
        #userStatus {
            background-color: #fff; padding: 10px 15px; border-radius: 10px;
            margin-bottom: 10px; border: 1px solid #ddd; color: #555; font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        #userStatus strong { color: #2196f3; }

        #chatBox { 
            height: 450px; background: white; border: 1px solid #ddd; 
            border-radius: 15px; overflow-y: scroll; padding: 20px; 
            margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            display: flex; flex-direction: column; gap: 15px; 
        }

        .input-container { display: flex; gap: 10px; }
        #nickname { width: 20%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; }
        #chatInput { width: 60%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; }
        button { 
            width: 20%; padding: 12px; background: #2196f3; color: white; 
            border: none; border-radius: 8px; cursor: pointer; font-weight: bold; 
        }
        button:hover { background: #1976d2; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .msg-box { display: flex; flex-direction: column; max-width: 80%; }
        
        .msg-box.normal { align-self: flex-start; }
        .msg-box.normal .nickname { margin-left: 5px; margin-bottom: 5px; font-size: 13px; color: #666; font-weight: bold; }
        .msg-box.normal .content-wrapper { display: flex; align-items: flex-end; }
        .msg-box.normal .message { background-color: #e9efff; border-radius: 0 15px 15px 15px; }

        .msg-box.admin { align-self: flex-end; align-items: flex-end; }
        .msg-box.admin .nickname { margin-right: 5px; margin-bottom: 5px; font-size: 13px; color: #0d47a1; font-weight: 900; }
        .msg-box.admin .content-wrapper { display: flex; flex-direction: row-reverse; align-items: flex-end; }
        .msg-box.admin .message { background-color: #e3f2fd; border: 2px solid #2196f3; border-radius: 15px 0 15px 15px; color: #333; font-weight: bold; }

        .system { align-self: center; margin: 10px 0; text-align: center; width: 100%; }
        .system span { background-color: #eee; color: #666; padding: 5px 15px; border-radius: 20px; font-size: 12px; display: inline-block; }

        .message { padding: 10px 15px; font-size: 15px; word-break: break-all; white-space: pre-wrap; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .mention-label { display: block; font-size: 11px; font-weight: bold; color: #2196f3; margin-bottom: 4px; border-bottom: 1px dashed #aecdff; padding-bottom: 2px; }
        .time { font-size: 10px; color: #aaa; margin: 0 5px; white-space: nowrap; margin-bottom: 2px; }
        a { color: #007bff; text-decoration: underline; cursor: pointer; }
        /* index.htmlì˜ <style> íƒœê·¸ ì•ˆì— ì¶”ê°€ */

    /* ğŸ‘‡ [NEW] ìœ íŠœë¸Œ ì¸ë„¤ì¼ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .youtube-preview {
            margin-top: 10px;
            max-width: 300px; /* ë„ˆë¬´ í¬ì§€ ì•Šê²Œ ìµœëŒ€ ë„ˆë¹„ ì œí•œ */
            border-radius: 12px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
            overflow: hidden; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ ë°–ìœ¼ë¡œ ì´ë¯¸ì§€ ì•ˆ ì‚ì ¸ë‚˜ì˜¤ê²Œ */
            box-shadow: 0 2px 8px rgba(0,0,0,0.2); /* ì‚´ì§ ê·¸ë¦¼ì */
            cursor: pointer;
        }    
        /* ì¸ë„¤ì¼ ì´ë¯¸ì§€ ìì²´ ìŠ¤íƒ€ì¼ */
            .youtube-preview img {
            width: 100%;
            height: auto;
            display: block; /* ì´ë¯¸ì§€ í•˜ë‹¨ ë¹ˆ ê³µê°„ ì œê±° */
        }
        /* ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ íš¨ê³¼ */
        .youtube-preview:hover {
            opacity: 0.9;
        }
        
        /* ğŸ‘‡ [NEW] ì¼ë°˜ ë§í¬ ë¯¸ë¦¬ë³´ê¸° ì¹´ë“œ ìŠ¤íƒ€ì¼ */
.link-card {
    display: flex;
    margin-top: 10px;
    border: 1px solid #ddd;
    border-radius: 10px;
    overflow: hidden;
    background: white;
    max-width: 350px;
    text-decoration: none; /* ë§í¬ ë°‘ì¤„ ì œê±° */
    color: inherit; /* ê¸€ììƒ‰ ìƒì† */
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    transition: transform 0.2s;
}
.link-card:hover { transform: translateY(-3px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }

.link-card img {
    width: 100px; /* ì¸ë„¤ì¼ í¬ê¸° ê³ ì • */
    height: 100px;
    object-fit: cover; /* ë¹„ìœ¨ ìœ ì§€í•˜ë©° ê½‰ ì±„ìš°ê¸° */
}

.link-info {
    padding: 10px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    overflow: hidden;
}

.link-title {
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 5px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis; /* ë§ì¤„ì„í‘œ */
}

.link-desc {
    font-size: 12px;
    color: #666;
    display: -webkit-box;
    -webkit-line-clamp: 2; /* ë‘ ì¤„ê¹Œì§€ë§Œ í‘œì‹œ */
    -webkit-box-orient: vertical;
    overflow: hidden;
}
    </style>
</head>
<body>
    <h1 style="text-align: center; color: #333;">ğŸ’¬ ì±„íŒ…ë°©</h1>
    
    <div id="userStatus">í˜„ì¬ ì ‘ì†ì: <strong>0ëª…</strong> (ë¡œë”©ì¤‘...)</div>
    <div id="chatBox"></div>
    
    <div class="input-container">
        <input type="text" id="nickname" placeholder="ë‹‰ë„¤ì„(ê³µë°±ë¶ˆê°€,20ê¸€ìì´ë‚´,ì¤‘ë³µë¶ˆê°€)" maxlength="1234567890" oninput="checkNickname(this)">
        <input type="text" id="chatInput" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="handleEnter(event)" onkeydown="handleKeyDown(event)">
        <button onclick="sendMyMessage()">ì „ì†¡</button>
    </div>

    <script>
        var socket = io({transports: ['websocket', 'polling']});
        var myMsgHistory = [];  
        var historyIndex = -1;  
        var tempMsg = "";

        // ë‹‰ë„¤ì„ ê³µë°± ì œê±° í•¨ìˆ˜ (ì•ˆì „í•˜ê²Œ ë¶„ë¦¬í•¨)
        function checkNickname(element) {
            element.value = element.value.replace(/\s/g, '');
        }

        function linkify(text) {
            var urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, function(url) {
                return '<a href="' + url + '" target="_blank">' + url + '</a>';
            });
        }

        function handleKeyDown(e) {
            var chatInput = document.getElementById('chatInput');
            if (e.key === "ArrowUp") {
                e.preventDefault(); 
                if (historyIndex === -1) {
                    tempMsg = chatInput.value;
                    historyIndex = myMsgHistory.length - 1; 
                } else if (historyIndex > 0) {
                    historyIndex--; 
                }
                if (historyIndex >= 0 && myMsgHistory[historyIndex]) {
                    chatInput.value = myMsgHistory[historyIndex];
                }
            } else if (e.key === "ArrowDown") {
                e.preventDefault();
                if (historyIndex !== -1) {
                    if (historyIndex < myMsgHistory.length - 1) {
                        historyIndex++; 
                        chatInput.value = myMsgHistory[historyIndex];
                    } else {
                        historyIndex = -1;
                        chatInput.value = tempMsg;
                    }
                }
            }
        }

        function sendMyMessage() {
            var nickInput = document.getElementById('nickname');
            var chatInput = document.getElementById('chatInput');
            var msg = chatInput.value;
            var nick = nickInput.value;
            var newmsg = msg.replace(/\s/g, "");
            var admin_list = ["#064473","#80278027","14141815"];
            var isAdmin = admin_list.some(pass => nick.includes(pass));
            
            if (nick.trim() === "") {
                alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
                nickInput.focus(); return; 
            }
            if (nick.length > 20 && !isAdmin) {
                alert("ë‹‰ë„¤ì„ì€ 20ê¸€ìê¹Œì§€ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                nickInput.value = ""; nickInput.focus(); return; 
            }
            if (newmsg.length > 1000) {
                alert("ë©”ì‹œì§€ê°€ ë„ˆë¬´ ê¹ë‹ˆë‹¤ (1000ì ì œí•œ,ê³µë°±ì œì™¸).");
                chatInput.focus(); return; 
            }
            if (msg.includes('ë€','ë£¨','ë¡œ','ë‚ ','ë“œ')){
                alert("ì–´ë”œ ë€ë€ë£¨ë“œë¦½ì„ ã…‰ã…‰")
                chatInput.value = "";
                chatInput.focus; return;
            }
            if(msg.trim() !== "") {
                socket.emit('my_chat', { name: nick, msg: msg });
                myMsgHistory.push(msg); 
                historyIndex = -1; tempMsg = ""; chatInput.value = ""; 
            }
        }

        function handleEnter(e) { if (e.key === "Enter") sendMyMessage(); }

        // ğŸ‘‡ ì—¬ê¸°ë¥¼ í†µì§¸ë¡œ ë°”ê¿”ì¤˜!
        socket.on('my_chat', function(data) {
            var chatBox = document.getElementById('chatBox');
            var finalMsg = data.msg;
            // ê¸°ë³¸ ë§í¬ ë³€í™˜ (í…ìŠ¤íŠ¸ì— ìˆëŠ” ì£¼ì†Œë¥¼ íŒŒë€ìƒ‰ ë§í¬ë¡œ)
            if (!data.msg.includes('<a href')) { finalMsg = linkify(data.msg); }
            
            var timeStr = data.time ? data.time : "";
            var mentionHtml = data.mention ? `<span class='mention-label'>@${data.mention}ì—ê²Œ</span>` : "";
            
            // ğŸ‘‡ [NEW] ìœ íŠœë¸Œ ì¸ë„¤ì¼ HTML ë§Œë“¤ê¸°
            var youtubeHtml = "";
            if (data.yt_thumb && data.yt_link) {
                // ì¸ë„¤ì¼ ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ë©´ ìœ íŠœë¸Œ ì˜ìƒìœ¼ë¡œ ìƒˆ ì°½ì´ ì—´ë¦¬ê²Œ ë§Œë“¦
                youtubeHtml = `
                    <div class='youtube-preview'>
                        <a href='${data.yt_link}' target='_blank'>
                            <img src='${data.yt_thumb}' alt='ìœ íŠœë¸Œ ë¯¸ë¦¬ë³´ê¸°'>
                        </a>
                    </div>`;
            }
            
            var linkHtml = "";
            if (data.link_data) {
                var d = data.link_data;
                linkHtml = `
                    <a href='${d.url}' target='_blank' class='link-card'>
                        <img src='${d.image}' alt='ë¯¸ë¦¬ë³´ê¸°'>
                        <div class='link-info'>
                            <div class='link-title'>${d.title}</div>
                            <div class='link-desc'>${d.description}</div>
                        </div>
                    </a>
                `;
            }
            
            var imageHtml = "";
            // ë©”ì‹œì§€ê°€ jpg, png, gif, jpeg, webp ë¡œ ëë‚˜ëŠ” ì£¼ì†Œì¸ì§€ ê²€ì‚¬
            if (data.msg.match(/\.(jpg|jpeg|png|gif|webp)$/i)) {
                // ì´ë¯¸ì§€ íƒœê·¸ë¥¼ ë§Œë“¤ì–´ì„œ ë³´ì—¬ì¤Œ (ìŠ¤íƒ€ì¼: ìµœëŒ€ ë„ˆë¹„ 250px, ë‘¥ê·¼ ëª¨ì„œë¦¬)
                imageHtml = `<br><a href="${data.msg}" target="_blank">
                                <img src="${data.msg}" style="max-width: 250px; max-height: 250px; border-radius: 10px; margin-top: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                             </a>`;
            }

            var html = "";
            if (data.role === 'system') {
                html = `<div class='system'><span>${finalMsg} <span style='color:#bbb; font-size:10px;'>(${timeStr})</span></span></div>`;
            } else if (data.role === 'admin') {
                // ğŸ‘‡ ê´€ë¦¬ì ë©”ì‹œì§€ì—ë„ youtubeHtml ì¶”ê°€
                html = `<div class='msg-box admin'>
                            <span class='nickname'>${data.name} âœ”ï¸(Official)</span>
                            <div class='content-wrapper'>
                                <div class='message'>${mentionHtml}${finalMsg}${youtubeHtml}${imageHtml}</div>
                                <span class='time'>${timeStr}</span>
                            </div>
                        </div>`;
            } else {
                // ğŸ‘‡ ì¼ë°˜ ë©”ì‹œì§€ì—ë„ youtubeHtml ì¶”ê°€
                html = `<div class='msg-box normal'>
                            <span class='nickname'>${data.name}</span>
                            <div class='content-wrapper'>
                                <div class='message'>${mentionHtml}${finalMsg}${youtubeHtml}${imageHtml}</div>
                                <span class='time'>${timeStr}</span>
                            </div>
                        </div>`;
            }
            chatBox.innerHTML += html;
            chatBox.scrollTop = chatBox.scrollHeight;
        });

        socket.on('update_users', function(data) {
            var statusDiv = document.getElementById('userStatus');
            var userNames = data.users.join(", ");
            statusDiv.innerHTML = `í˜„ì¬ ì ‘ì†ì: <strong>${data.count}ëª…</strong> (${userNames})`;
        });

        socket.on('disconnect', function() {
            var chatBox = document.getElementById('chatBox');
            chatBox.innerHTML += "<div class='system' style='color:red; font-weight:bold;'>ğŸš« ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.</div>";
            document.getElementById('chatInput').disabled = true;
            document.querySelector('button').disabled = true;
        });
    </script>
</body>
</html>











